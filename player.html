<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Arcade Challenge Player</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); color: #fff; font-family: 'Cinzel', serif; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; margin: 0; text-align: center; padding: 20px; box-sizing: border-box; }
        .container { 
            background: rgba(0, 0, 0, 0.4); border: 5px solid #ff007f; border-radius: 40px; padding: 20px; box-shadow: 0 0 30px rgba(255, 0, 127, 0.5); max-width: 90%; width: 100%; position: relative;
            background-image: url('https://raw.githubusercontent.com/ajersj-cmyk/arcade-challenge/main/quest/mickeyintro/1.jpg');
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat;
            transition: background-image 0.5s ease-in-out;
            background-color: #0f0c29;
        }
        #main-title { margin-bottom: 20px; flex-shrink: 0; }
        #main-title img { max-width: 100%; max-height: 20vh; height: auto; }
        #player-display { 
            font-size: 3.5vw; 
            font-weight: bold;
            color: #ff007f;
            margin-bottom: 15px;
            animation: purple-text-pulse 4s infinite alternate;
        }
        .challenge-section { 
            background: rgba(0, 0, 0, 0.6); 
            color: #fff; 
            border-radius: 20px; 
            padding: 20px; 
            min-height: 200px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            margin-bottom: 20px; 
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        #challenge-text { font-size: 4vw; font-weight: bold; margin: 0; }
        #challenge-details { font-size: 2.2vw; margin-top: 15px; opacity: 0.9; }
        .btn-container, .challenge-action-form { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 15px; }
        button { 
            background: #ff007f; color: #fff; font-family: 'Cinzel', serif; font-weight: bold; border: none; padding: 20px; font-size: 2.5vw; cursor: pointer; border-radius: 12px; text-transform: uppercase; transition: transform 0.2s, box-shadow 0.2s; 
            box-shadow: 0 6px 0 #cc0066; 
        }
        button:active { transform: translateY(3px); box-shadow: 0 3px 0 #cc0066; }
        #done-btn { 
            background: #ff007f;
            color: #fff; 
            animation: purple-button-pulse 4s infinite alternate;
        }
        #impossible-btn { background-color: #9d00ff; box-shadow: 0 6px 0 #6e00b3; }
        .name-entry-form { padding: 20px; margin-top: 15px; display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .name-entry-form input[type="text"] { background: #fff; color: #000; border: none; padding: 15px; border-radius: 10px; font-family: 'Cinzel', serif; font-size: 3vw; width: 80%; }
        
        /* NEW: Styles for the fullscreen intro screen */
        #intro-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            z-index: 100;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 5vh;
        }
        #start-quest-btn {
            padding: 20px 40px;
            font-size: 4vw;
            background-color: #00ffff;
            color: #302b63;
            border: 3px solid #fff;
            animation: rainbow-pulse 4s linear infinite;
        }
        
        @keyframes purple-text-pulse {
            from { text-shadow: 0 0 4px #4b0082, 0 0 8px #4b0082; }
            to { text-shadow: 0 0 8px #4b0082, 0 0 16px #4b0082, 0 0 24px #4b0082; }
        }
        @keyframes purple-button-pulse {
            from { box-shadow: 0 6px 0 #6e00b3, 0 0 10px #4b0082, 0 0 20px #4b0082; }
            to { box-shadow: 0 6px 0 #6e00b3, 0 0 20px #4b0082, 0 0 40px #4b0082, 0 0 60px #4b0082; }
        }
        @keyframes rainbow-pulse { 0% { box-shadow: 0 0 15px 5px #ff0000, 0 6px 0 #00cccc; } 16% { box-shadow: 0 0 15px 5px #ff7f00, 0 6px 0 #00cccc; } 33% { box-shadow: 0 0 15px 5px #ffff00, 0 6px 0 #00cccc; } 50% { box-shadow: 0 0 15px 5px #00ff00, 0 6px 0 #00cccc; } 66% { box-shadow: 0 0 15px 5px #0000ff, 0 6px 0 #00cccc; } 83% { box-shadow: 0 0 15px 5px #4b0082, 0 6px 0 #00cccc; } 100% { box-shadow: 0 0 15px 5px #ff0000, 0 6px 0 #00cccc; } }

    </style>
</head>
<body>
    <div id="intro-screen">
        <button id="start-quest-btn">Start Quest</button>
    </div>

    <div class="container" id="main-container">
        <h1 id="main-title"><img src="https://raw.githubusercontent.com/ajersj-cmyk/arcade-challenge/main/header.PNG" alt="Ahlers Arcade Challenge"></h1>
        <p id="player-display" style="display: none;"></p>
        <div class="challenge-section" id="challenge-box">
            <p id="challenge-text">What is your name, Adventurer?</p>
            <div id="challenge-details"></div>
            <div class="name-entry-form" id="name-entry-form"><input type="text" id="player-name-input" placeholder="Enter Your Name"><button id="start-session-btn">Start / Continue</button></div>
            <div class="challenge-action-form" id="challenge-action-form" style="display: none;"><button id="complete-challenge-btn">Completed!</button><button id="skip-challenge-btn">Skip (-5 pts)</button><button id="impossible-btn">This is Impossible</button></div>
            <div class="success-screen" id="success-screen" style="display: none;"><button id="next-quest-btn">Next Quest</button></div>
        </div>
        <div class="btn-container"><button class="mode-toggle-btn" id="mode-toggle">Switch to Adult Mode</button><button id="done-btn" style="display: none;">Save & Quit</button></div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const scoresApiUrl = "https://script.google.com/macros/s/AKfycbzVzQirgLxs7Pse85u7RStzQFL-yJz8ZD9-PuVrfko9wBCm7lKbS9N5dQxZSvXj_eMW/exec";
        const challengesUrl = "https://script.google.com/macros/s/AKfycbxj_xzLgkkQqsXKyBA4mJLvuTbzuDemZv8SYXMVD6gPeTzQOsJjH8iiEYDaaaNFpjIc/exec"; 

        const mainContainer = document.getElementById('main-container');
        const challengeText = document.getElementById('challenge-text');
        const challengeDetails = document.getElementById('challenge-details');
        const nameEntryForm = document.getElementById('name-entry-form');
        const challengeActionForm = document.getElementById('challenge-action-form');
        const playerNameInput = document.getElementById('player-name-input');
        const startSessionBtn = document.getElementById('start-session-btn');
        const playerDisplay = document.getElementById('player-display');
        const doneBtn = document.getElementById('done-btn');
        const modeToggleBtn = document.getElementById('mode-toggle');
        const successScreen = document.getElementById('success-screen');
        const nextQuestBtn = document.getElementById('next-quest-btn');
        // NEW: Element references for the intro screen
        const introScreen = document.getElementById('intro-screen');
        const startQuestBtn = document.getElementById('start-quest-btn');
        
        let allChallenges = []; 
        let isKidMode = true; 
        let currentPlayerName = null; 
        let currentChallenge = null; 
        let historicalScore = 0; 
        let sessionScore = 0; 
        let hiddenChallenges = JSON.parse(localStorage.getItem('hiddenChallenges')) || {};
        let challengeCounter = 0;
        
        const getRandomImageNumber = (max) => { const count = Number(max) || 1; return Math.floor(Math.random() * count) + 1; };
        const getCharacterFolderName = (character) => character.toLowerCase().replace(/\s+/g, '');
        
        const fetchChallenges = async () => { try { const response = await fetch(challengesUrl); if (!response.ok) throw new Error('Network response was not ok'); allChallenges = await response.json(); challengeText.textContent = "What is your name, Adventurer?"; } catch (error) { console.error("Failed to fetch challenges:", error); challengeText.textContent = "Error: Could not load challenges. Please refresh."; } };
        const lookupPlayerScore = async (name) => { startSessionBtn.textContent = "Loading..."; try { const response = await fetch(scoresApiUrl); const data = await response.json(); const playerScores = (data.sheet1 || []).filter(entry => entry.playername === name); return playerScores.reduce((total, entry) => total + (Number(entry.score) || 0), 0); } catch (error) { console.error("Could not look up score:", error); return 0; } finally { startSessionBtn.textContent = "Start / Continue"; } };
        
        const addScoreToSheet = async (playerName, score, mode) => {
            if (score === 0) { window.location.reload(); return; }
            try {
                await fetch(scoresApiUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ playername: playerName, score: score, mode: mode })
                });
            } catch (error) { console.error('FETCH FAILED:', error); } 
            finally { window.location.reload(); }
        };

        const startNewChallenge = () => {
            let desiredMode = isKidMode ? 'Kid' : 'Adult';
            let challengePool = allChallenges.filter(c => c.mode === desiredMode);
            const activeChallenges = challengePool.filter(c => !hiddenChallenges[c.uniqueId]);
            if (activeChallenges.length === 0) {
                challengeText.textContent = "Wow! You've completed all challenges in this mode!";
                challengeDetails.innerHTML = '';
                challengeActionForm.style.display = 'none';
                return;
            }
            currentChallenge = activeChallenges[Math.floor(Math.random() * activeChallenges.length)];
            const charFolder = getCharacterFolderName(currentChallenge.character);
            const imgNum = getRandomImageNumber(currentChallenge.introimagecount); 
            const imageUrl = `https://raw.githubusercontent.com/ajersj-cmyk/arcade-challenge/main/quest/${charFolder}intro/${imgNum}.jpg`;
            mainContainer.style.backgroundImage = `url('${imageUrl}')`;
            challengeText.textContent = currentChallenge.text;
            challengeDetails.innerHTML = `Difficulty: ${currentChallenge.difficulty} | Points: ${currentChallenge.points}`;
            nameEntryForm.style.display = 'none';
            doneBtn.style.display = 'inline-block';
            modeToggleBtn.style.display = 'none';
            challengeActionForm.style.display = 'flex';
            successScreen.style.display = 'none';
        };

        const showWinScreen = () => {
            const charFolder = getCharacterFolderName(currentChallenge.character);
            const imgNum = getRandomImageNumber(currentChallenge.winimagecount);
            const imageUrl = `https://raw.githubusercontent.com/ajersj-cmyk/arcade-challenge/main/quest/${charFolder}win/${imgNum}.jpg`;
            mainContainer.style.backgroundImage = `url('${imageUrl}')`;
            challengeText.textContent = currentChallenge.successQuote;
            challengeDetails.innerHTML = `+${currentChallenge.points} points!`;
            challengeActionForm.style.display = 'none';
            successScreen.style.display = 'flex';
        };
        
        const updateScore = (points) => {
            if (currentChallenge) {
                hiddenChallenges[currentChallenge.uniqueId] = true;
                localStorage.setItem('hiddenChallenges', JSON.stringify(hiddenChallenges));
            }
            sessionScore += points;
            const totalScore = historicalScore + sessionScore;
            playerDisplay.innerHTML = `Player: ${currentPlayerName} | Total Score: ${totalScore}`;
            if (points > 0) {
                showWinScreen();
            } else {
                startNewChallenge();
            }
        };
        
        // ### THIS IS THE ONLY MODIFIED FUNCTION ###
        startSessionBtn.addEventListener('click', async () => {
            const name = playerNameInput.value.trim();
            if (!name) { alert('Please enter your name.'); return; }
            if (allChallenges.length === 0) { alert('Challenges are still loading, please wait a moment!'); return; }
            currentPlayerName = name;
            historicalScore = await lookupPlayerScore(name);
            sessionScore = 0;
            playerDisplay.innerHTML = `Player: ${currentPlayerName} | Total Score: ${historicalScore}`;
            
            // This new logic shows the fullscreen intro
            mainContainer.style.display = 'none';
            const introImageUrl = 'https://raw.githubusercontent.com/ajersj-cmyk/arcade-challenge/main/quest/intro/intro.jpg';
            introScreen.style.backgroundImage = `url('${introImageUrl}')`;
            introScreen.style.display = 'flex';
        });
        
        // NEW: This function runs when the "Start Quest" button is clicked
        startQuestBtn.addEventListener('click', () => {
            introScreen.style.display = 'none';
            mainContainer.style.display = 'block'; // Use 'block' to respect original layout
            playerDisplay.style.display = 'block';
            challengeCounter = 1;
            startNewChallenge();
        });
        
        document.getElementById('complete-challenge-btn').addEventListener('click', () => updateScore(currentChallenge.points));
        document.getElementById('skip-challenge-btn').addEventListener('click', () => updateScore(-5));
        document.getElementById('impossible-btn').addEventListener('click', () => updateScore(0));
        nextQuestBtn.addEventListener('click', startNewChallenge);
        doneBtn.addEventListener('click', async () => { if (currentPlayerName) { const mode = isKidMode ? 'Kid' : 'Adult'; await addScoreToSheet(currentPlayerName, sessionScore, mode); } else { window.location.reload(); } });
        modeToggleBtn.addEventListener('click', () => { isKidMode = !isKidMode; modeToggleBtn.textContent = isKidMode ? 'Switch to Adult Mode' : 'Switch to Kid Mode'; });
        
        challengeText.textContent = "Loading challenges...";
        fetchChallenges();
    });
    </script>
</body>
</html>